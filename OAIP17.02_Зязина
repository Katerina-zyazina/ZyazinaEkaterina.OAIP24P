import json
import os
import sys
from datetime import datetime

# === –ó–ê–ì–†–£–ó–ö–ê –ò –°–û–•–†–ê–ù–ï–ù–ò–ï ===
def load_data():
    """–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ JSON —Ñ–∞–π–ª–∞"""
    filename = 'projects.json'
    if os.path.exists(filename):
        try:
            with open(filename, 'r', encoding='utf-8') as file:
                return json.load(file)
        except:
            return []
    return []

def save_data(projects):
    """–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ JSON —Ñ–∞–π–ª"""
    filename = 'projects.json'
    try:
        with open(filename, 'w', encoding='utf-8') as file:
            json.dump(projects, file, ensure_ascii=False, indent=2)
    except:
        print("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞")

# === –§–£–ù–ö–¶–ò–Ø –ë–ï–ó–û–ü–ê–°–ù–û–ì–û –í–í–û–î–ê ===
def safe_input(prompt):
    """–ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –≤–≤–æ–¥ —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫"""
    try:
        return input(prompt).strip()
    except EOFError:
        print("\n‚ùå –û—à–∏–±–∫–∞ –≤–≤–æ–¥–∞. –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã.")
        sys.exit(1)
    except KeyboardInterrupt:
        print("\n\nüëã –ü—Ä–æ–≥—Ä–∞–º–º–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º")
        sys.exit(0)

# === –§–£–ù–ö–¶–ò–ò –î–õ–Ø –ü–†–û–ï–ö–¢–û–í ===
def show_projects(projects):
    """–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –ø—Ä–æ–µ–∫—Ç—ã"""
    print("\n" + "="*60)
    print("                  –ü–†–û–ï–ö–¢–´")
    print("="*60)
    
    if not projects:
        print("üìÅ –ù–µ—Ç —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤")
        return
    
    for i, project in enumerate(projects, 1):
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∏–∫–æ–Ω–∫—É —Å—Ç–∞—Ç—É—Å–∞
        if project['status'] == '–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ':
            icon = 'üìù'
        elif project['status'] == '–≤ —Ä–∞–±–æ—Ç–µ':
            icon = 'üîÑ'
        elif project['status'] == '–≥–æ—Ç–æ–≤':
            icon = '‚úÖ'
        else:
            icon = 'üìå'
        
        print(f"\n{i}. {icon} {project['name']}")
        print(f"   –°—Ç–∞—Ç—É—Å: {project['status']}")
        print(f"   –ó–∞–¥–∞—á: {len(project['tasks'])}")
        print(f"   –°–æ–∑–¥–∞–Ω: {project['created_date']}")

def create_project(projects):
    """–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç"""
    print("\n" + "="*60)
    print("              –°–û–ó–î–ê–ù–ò–ï –ü–†–û–ï–ö–¢–ê")
    print("="*60)
    
    name = safe_input("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞: ")
    
    if not name:
        print("‚ùå –û—à–∏–±–∫–∞: –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º")
        return projects
    
    print("\n–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ç—É—Å:")
    print("1. –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ")
    print("2. –í —Ä–∞–±–æ—Ç–µ")
    print("3. –ì–æ—Ç–æ–≤")
    
    choice = safe_input("–í–∞—à –≤—ã–±–æ—Ä (1-3): ")
    
    if choice == "1":
        status = "–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ"
    elif choice == "2":
        status = "–≤ —Ä–∞–±–æ—Ç–µ"
    elif choice == "3":
        status = "–≥–æ—Ç–æ–≤"
    else:
        status = "–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ"
        print("‚ö†Ô∏è –í—ã–±—Ä–∞–Ω —Å—Ç–∞—Ç—É—Å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ")
    
    # –°–æ–∑–¥–∞–µ–º –ø—Ä–æ–µ–∫—Ç
    project = {
        'name': name,
        'status': status,
        'created_date': datetime.now().strftime("%d.%m.%Y %H:%M"),
        'tasks': []
    }
    
    projects.append(project)
    save_data(projects)
    print(f"\n‚úÖ –ü—Ä–æ–µ–∫—Ç '{name}' —Å–æ–∑–¥–∞–Ω!")
    
    return projects

def change_project_status(projects):
    """–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø—Ä–æ–µ–∫—Ç–∞"""
    print("\n" + "="*60)
    print("           –ò–ó–ú–ï–ù–ï–ù–ò–ï –°–¢–ê–¢–£–°–ê")
    print("="*60)
    
    if not projects:
        print("‚ùå –ù–µ—Ç –ø—Ä–æ–µ–∫—Ç–æ–≤")
        return projects
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–µ–∫—Ç—ã
    for i, project in enumerate(projects, 1):
        print(f"{i}. {project['name']} (—Å—Ç–∞—Ç—É—Å: {project['status']})")
    
    try:
        num = safe_input("\n–í—ã–±–µ—Ä–∏—Ç–µ –Ω–æ–º–µ—Ä –ø—Ä–æ–µ–∫—Ç–∞: ")
        
        if not num:
            print("‚ùå –í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä")
            return projects
            
        idx = int(num) - 1
        
        if 0 <= idx < len(projects):
            project = projects[idx]
            
            print(f"\n–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å: {project['status']}")
            print("1. –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ üìù")
            print("2. –í —Ä–∞–±–æ—Ç–µ üîÑ")
            print("3. –ì–æ—Ç–æ–≤ ‚úÖ")
            
            choice = safe_input("–ù–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å (1-3): ")
            
            if choice == "1":
                new_status = "–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ"
            elif choice == "2":
                new_status = "–≤ —Ä–∞–±–æ—Ç–µ"
            elif choice == "3":
                new_status = "–≥–æ—Ç–æ–≤"
            else:
                print("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä")
                return projects
            
            old = project['status']
            project['status'] = new_status
            save_data(projects)
            print(f"\n‚úÖ –°—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω–µ–Ω: '{old}' ‚Üí '{new_status}'")
        else:
            print("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –Ω–æ–º–µ—Ä")
    except ValueError:
        print("‚ùå –í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ")
    
    return projects

# === –§–£–ù–ö–¶–ò–ò –î–õ–Ø –ó–ê–î–ê–ß ===
def add_task(projects):
    """–î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É –≤ –ø—Ä–æ–µ–∫—Ç"""
    print("\n" + "="*60)
    print("              –î–û–ë–ê–í–õ–ï–ù–ò–ï –ó–ê–î–ê–ß–ò")
    print("="*60)
    
    if not projects:
        print("‚ùå –ù–µ—Ç –ø—Ä–æ–µ–∫—Ç–æ–≤")
        return projects
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–µ–∫—Ç—ã
    for i, project in enumerate(projects, 1):
        print(f"{i}. {project['name']} (–∑–∞–¥–∞—á: {len(project['tasks'])})")
    
    try:
        num = safe_input("\n–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç: ")
        
        if not num:
            print("‚ùå –í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä")
            return projects
            
        idx = int(num) - 1
        
        if 0 <= idx < len(projects):
            task_name = safe_input("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏: ")
            
            if not task_name:
                print("‚ùå –ù–∞–∑–≤–∞–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º")
                return projects
            
            task = {
                'name': task_name,
                'created_date': datetime.now().strftime("%d.%m.%Y %H:%M"),
                'completed': False
            }
            
            projects[idx]['tasks'].append(task)
            save_data(projects)
            print(f"\n‚úÖ –ó–∞–¥–∞—á–∞ '{task_name}' –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ –ø—Ä–æ–µ–∫—Ç '{projects[idx]['name']}'")
        else:
            print("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –Ω–æ–º–µ—Ä")
    except ValueError:
        print("‚ùå –í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ")
    
    return projects

def show_tasks(projects):
    """–ü–æ–∫–∞–∑–∞—Ç—å –∑–∞–¥–∞—á–∏ –≤ –ø—Ä–æ–µ–∫—Ç–µ"""
    print("\n" + "="*60)
    print("              –ó–ê–î–ê–ß–ò –ü–†–û–ï–ö–¢–ê")
    print("="*60)
    
    if not projects:
        print("‚ùå –ù–µ—Ç –ø—Ä–æ–µ–∫—Ç–æ–≤")
        return
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–µ–∫—Ç—ã
    for i, project in enumerate(projects, 1):
        print(f"{i}. {project['name']}")
    
    try:
        num = safe_input("\n–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç: ")
        
        if not num:
            print("‚ùå –í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä")
            return
            
        idx = int(num) - 1
        
        if 0 <= idx < len(projects):
            project = projects[idx]
            
            print(f"\nüìÅ –ü—Ä–æ–µ–∫—Ç: {project['name']}")
            print(f"üìä –°—Ç–∞—Ç—É—Å: {project['status']}")
            print("-" * 40)
            
            if not project['tasks']:
                print("üì≠ –ù–µ—Ç –∑–∞–¥–∞—á")
            else:
                for i, task in enumerate(project['tasks'], 1):
                    if task['completed']:
                        status = "‚úÖ"
                    else:
                        status = "‚≠ï"
                    print(f"{status} {i}. {task['name']}")
                    print(f"   –î–æ–±–∞–≤–ª–µ–Ω–∞: {task['created_date']}")
                    
                    # –°–ø—Ä–∞—à–∏–≤–∞–µ–º, –æ—Ç–º–µ—Ç–∏—Ç—å –ª–∏ –∑–∞–¥–∞—á—É –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—É—é
                    if not task['completed']:
                        mark = safe_input(f"   –û—Ç–º–µ—Ç–∏—Ç—å –∑–∞–¥–∞—á—É {i} –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—É—é? (–¥/–Ω): ").lower()
                        if mark in ['–¥', '–¥–∞', 'yes', 'y']:
                            task['completed'] = True
                            save_data(projects)
                            print("   ‚úÖ –ó–∞–¥–∞—á–∞ –æ—Ç–º–µ—á–µ–Ω–∞ –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–∞—è!")
        else:
            print("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –Ω–æ–º–µ—Ä")
    except ValueError:
        print("‚ùå –í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ")

# === –ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø ===
def main():
    """–ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≥—Ä–∞–º–º—ã"""
    projects = load_data()
    
    while True:
        print("\n" + "="*60)
        print("           –ú–ï–ù–ï–î–ñ–ï–† –ü–†–û–ï–ö–¢–û–í –ò –ó–ê–î–ê–ß")
        print("="*60)
        print("1. üìã –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –ø—Ä–æ–µ–∫—Ç—ã")
        print("2. ‚ú® –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–µ–∫—Ç")
        print("3. ‚ûï –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É")
        print("4. üìä –ü–æ–∫–∞–∑–∞—Ç—å –∑–∞–¥–∞—á–∏ –ø—Ä–æ–µ–∫—Ç–∞")
        print("5. üîÑ –ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø—Ä–æ–µ–∫—Ç–∞")
        print("6. üö™ –í—ã—Ö–æ–¥")
        print("="*60)
        
        choice = safe_input("\n–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ (1-6): ")
        
        if choice == "1":
            show_projects(projects)
        
        elif choice == "2":
            projects = create_project(projects)
        
        elif choice == "3":
            projects = add_task(projects)
        
        elif choice == "4":
            show_tasks(projects)
        
        elif choice == "5":
            projects = change_project_status(projects)
        
        elif choice == "6":
            save_data(projects)
            print("\nüíæ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã")
            print("üëã –î–æ —Å–≤–∏–¥–∞–Ω–∏—è!")
            break
        
        else:
            print("\n‚ùå –û—à–∏–±–∫–∞: –≤—ã–±–µ—Ä–∏—Ç–µ 1-6")
        
        try:
            input("\n–ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è...")
        except (EOFError, KeyboardInterrupt):
            print("\n\nüëã –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã")
            break

# === –ó–ê–ü–£–°–ö ===
if __name__ == "__main__":
    try:
        main()
    except Exception as e:
        print(f"\n‚ùå –û—à–∏–±–∫–∞: {e}")
        print("–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—É —Å–Ω–æ–≤–∞")
